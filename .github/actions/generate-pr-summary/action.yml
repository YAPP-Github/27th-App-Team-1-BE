name: "Generate PR with AI"
description: "Generate PR body using OpenAI GPT (markdown only, with retries)"

inputs:
  openai_api_key:
    required: true
  stats_file:
    required: false
    default: "/tmp/stats.txt"
  files_file:
    required: false
    default: "/tmp/files.txt"
  diff_file:
    required: false
    default: "/tmp/diff.txt"

outputs:
  body:
    description: "Generated PR body in markdown format"
    value: "${{ steps.gen.outputs.body }}"

runs:
  using: "composite"
  steps:
    - name: "Generate PR Markdown"
      id: "gen"
      shell: "bash"
      env:
        OPENAI_API_KEY: "${{ inputs.openai_api_key }}"
      run: |
        set -euo pipefail

        # -----------------------------
        # 1) Prompt (MARKDOWN ONLY)
        # -----------------------------
        cat > /tmp/prompt.txt << 'EOF'
        You are an expert software engineer writing a professional Pull Request in Korean.

        IMPORTANT:
        - Analyze ALL changes comprehensively (Stats ‚Üí New Files ‚Üí Diff)
        - Pay special attention to newly added files and architectural changes

        OUTPUT RULES:
        - Return ONLY Markdown (no JSON, no code fences)
        - Use ###, #### for subsections, code blocks (```), lists, quotes (>)
        - Write naturally and professionally like a senior developer

        PR BODY STRUCTURE (4 sections):

        > ü§ñ **Ïù¥ PRÏùÄ OpenAI GPT-5-miniÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.**

        ## ÏöîÏïΩ
        ÌïµÏã¨ Î≥ÄÍ≤ΩÏÇ¨Ìï≠Í≥º Î™©Ï†ÅÏùÑ 1-2Î¨∏Ïû•ÏúºÎ°ú Í∞ÑÍ≤∞ÌïòÍ≤å ÏûëÏÑ±

        ## Ï£ºÏöî Î≥ÄÍ≤Ω ÏÇ¨Ìï≠
        Í∏∞Îä•/Î™®Îìà Îã®ÏúÑÎ°ú ÏûëÏÑ± (ÌååÏùºÎ™Ö ÎÇòÏó¥ Í∏àÏßÄ):
        - ### ÎòêÎäî #### ÏÑúÎ∏åÏÑπÏÖòÏúºÎ°ú Í∏∞Îä•Î≥Ñ Íµ¨Î∂Ñ
        - Í∞Å Í∏∞Îä•Ïùò ÌïµÏã¨Îßå Í∞ÑÎûµÌûà ÏÑ§Î™Ö
        - Î∂àÎ¶ø Ìè¨Ïù∏Ìä∏Î°ú ÏÑ∏Î∂ÄÏÇ¨Ìï≠ Ï†ïÎ¶¨

        ÏòàÏãú:
        ### 1. ÏÉàÎ°úÏö¥ Ïù∏Ï¶ù ÏãúÏä§ÌÖú
        - JWT Í∏∞Î∞ò ÌÜ†ÌÅ∞ Ïù∏Ï¶ù
        - Î¶¨ÌîÑÎ†àÏãú ÌÜ†ÌÅ∞ ÏûêÎèô Í∞±Ïã†

        ## ÏÉÅÏÑ∏ Íµ¨ÌòÑ ÎÇ¥Ïö©
        **ÏÑπÏÖòÏùÄ Î∞òÎìúÏãú Ïú†ÏßÄ, ÏïÑÎûò Ìï≠Î™©ÏùÄ Ìï¥ÎãπÏÇ¨Ìï≠Îßå ÏûëÏÑ±**

        ÌïÑÏöîÏãú ### ÏÑúÎ∏åÏÑπÏÖò ÏÇ¨Ïö©ÌïòÏó¨ Íµ¨Ï°∞Ìôî:
        - **ÏÉà Í∏∞Ïà†/ÎùºÏù¥Î∏åÎü¨Î¶¨**: ÏÇ¨Ïö©Î≤ï, ÏÑ§Ï†ï Î∞©Î≤ï, ÏΩîÎìú ÏòàÏãú ÌïÑÏàò
        - **ÏïÑÌÇ§ÌÖçÏ≤ò/Íµ¨Ï°∞ Î≥ÄÍ≤Ω**: Î≥ÄÍ≤Ω Ïù¥Ïú†ÏôÄ ÏÑ§Í≥Ñ ÏÑ§Î™Ö
        - **Î≥µÏû°Ìïú Î°úÏßÅ**: ÏïåÍ≥†Î¶¨Ï¶ò ÏÑ§Î™Ö
        - **Í∏∞Ïà†Ï†Å Í≤∞Ï†ï**: ÏÑ†ÌÉù Î∞∞Í≤ΩÍ≥º Ïù¥Ïú†
        - **ÌïÑÏöî ÏÑ§Ï†ï**: ÌôòÍ≤ΩÎ≥ÄÏàò, ÏãúÌÅ¨Î¶ø, Ï∂îÍ∞Ä ÏÑ§Ï†ï ÏïàÎÇ¥

        Î™®Îëê ÏóÜÏúºÎ©¥ "ÌäπÏù¥ÏÇ¨Ìï≠ ÏóÜÏùå" Ìïú Ï§ÑÎßå ÏûëÏÑ±

        ## Ìä∏Îü¨Î∏î ÏäàÌåÖ
        Íµ¨ÌòÑ Ï§ë Î∞úÏÉùÌïú Î¨∏Ï†úÏôÄ Ìï¥Í≤∞ Î∞©Î≤ï
        ÏóÜÏúºÎ©¥: "Ìä∏Îü¨Î∏îÏäàÌåÖ ÏÇ¨Ìï≠ ÏóÜÏùå"

        **Í∏àÏßÄÏÇ¨Ìï≠:**
        Ï∂îÍ∞Ä ÏÑπÏÖò(ÌÖåÏä§Ìä∏ Í≥ÑÌöç, Î¶¨Î∑∞ Ìè¨Ïù∏Ìä∏ Îì±) Ï†àÎåÄ Í∏àÏßÄ

        --- Stats ---
        EOF
        cat "${{ inputs.stats_file }}" >> /tmp/prompt.txt
        cat >> /tmp/prompt.txt << 'EOF'

        --- Files ---
        EOF
        cat "${{ inputs.files_file }}" >> /tmp/prompt.txt
        cat >> /tmp/prompt.txt << 'EOF'

        --- Diff ---
        EOF
        cat "${{ inputs.diff_file }}" >> /tmp/prompt.txt

        PROMPT="$(cat /tmp/prompt.txt)"
        echo "üìù Prompt size: $(printf "%s" "$PROMPT" | wc -c | tr -d ' ') characters"

        # -----------------------------
        # 2) Call OpenAI with retries
        # -----------------------------
        BODY=""

        for i in {1..3}; do
          echo "üîÑ OpenAI API Ìò∏Ï∂ú ÏãúÎèÑ $i/3"

          RESPONSE="$(curl -sS https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-5-mini\",
              \"input\": [
                {\"role\": \"system\", \"content\": \"Write a GitHub Pull Request body in Korean Markdown. Return markdown only.\"},
                {\"role\": \"user\", \"content\": $(printf \"%s\" \"$PROMPT\" | jq -Rs .)}
              ],
              \"max_output_tokens\": 4096
            }")"

          # API error Ï≤¥ÌÅ¨
          if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
            echo "‚ùå API Error: $(echo "$RESPONSE" | jq -r '.error.message // .error')"
            [ $i -lt 3 ] && sleep $((i * 2))
            continue
          fi

          # Markdown Î≥∏Î¨∏ Ï∂îÏ∂ú
          BODY="$(echo "$RESPONSE" | jq -r '[.output[]?.content[]?.text // ""] | join("")')"

          if [ -n "$BODY" ] && [ "$BODY" != "null" ]; then
            echo "‚úÖ PR ÏÉùÏÑ± ÏôÑÎ£å"
            break
          fi

          echo "‚ö†Ô∏è  Î≥∏Î¨∏ Ï∂îÏ∂ú Ïã§Ìå® - Ïû¨ÏãúÎèÑ Ï§ë"
          [ $i -lt 3 ] && sleep $((i * 2))
        done

        if [ -z "$BODY" ] || [ "$BODY" = "null" ]; then
          echo "‚ùå OpenAI API Ìò∏Ï∂ú Ïã§Ìå®(Î≥∏Î¨∏ ÎπÑÏñ¥ÏûàÏùå)"
          exit 1
        fi

        # -----------------------------
        # 3) Use markdown AS-IS
        # -----------------------------
        echo "body<<EOF" >> "$GITHUB_OUTPUT"
        printf "%s\n" "$BODY" >> "$GITHUB_OUTPUT"
        echo "EOF" >> "$GITHUB_OUTPUT"
