name: "Generate PR with AI"
description: "Generate PR body using OpenAI GPT (markdown only, with retries)"

inputs:
  openai_api_key:
    required: true
  stats_file:
    required: false
    default: "/tmp/stats.txt"
  files_file:
    required: false
    default: "/tmp/files.txt"
  diff_file:
    required: false
    default: "/tmp/diff.txt"

outputs:
  body:
    description: "Generated PR body in markdown format"
    value: "${{ steps.gen.outputs.body }}"

runs:
  using: "composite"
  steps:
    - name: "Generate PR Markdown"
      id: "gen"
      shell: "bash"
      env:
        OPENAI_API_KEY: "${{ inputs.openai_api_key }}"
      run: |
        set -euo pipefail

        # -----------------------------
        # 1) Prompt (MARKDOWN ONLY)
        # -----------------------------
        cat > /tmp/prompt.txt << 'EOF'
        You are an expert software engineer writing a professional Pull Request in Korean.

        IMPORTANT:
        - Analyze ALL changes in the diff comprehensively.
        - Pay special attention to newly added files and major architectural changes.

        OUTPUT RULES (VERY IMPORTANT):
        - Return ONLY Markdown.
        - Do NOT return JSON.
        - Do NOT wrap output in code fences.
        - The content will be used AS-IS as the GitHub PR body.

        **ÎßàÌÅ¨Îã§Ïö¥ ÏûëÏÑ± Í∑úÏπô:**
        - ###, #### Îì± Îã§ÏñëÌïú Ìó§Îî© Î†àÎ≤®ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Í≥ÑÏ∏µÏ†Å Íµ¨Ï°∞ ÌëúÌòÑ
        - ÏΩîÎìú Î∏îÎ°ù(```), Ïù∏Ïö©Î¨∏(>), Î¶¨Ïä§Ìä∏ Îì± ÎßàÌÅ¨Îã§Ïö¥ Î¨∏Î≤ïÏùÑ Ï†ÅÍ∑π ÌôúÏö©
        - Î≥¥Í∏∞ Ï¢ãÍ≤å Íµ¨Ï°∞ÌôîÌïòÏó¨ Í∞ÄÎèÖÏÑ± Ìñ•ÏÉÅ

        PR BODY STRUCTURE (Ï†ïÌôïÌûà ÏïÑÎûò 4Í∞ú ÏÑπÏÖòÎßå):

        > ü§ñ **Ïù¥ PRÏùÄ Open AI GPT-5-miniÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.**

        ## ÏöîÏïΩ
        Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïùò ÌïµÏã¨Í≥º Î™©Ï†ÅÏùÑ 1-2Î¨∏Ïû•ÏúºÎ°ú Í∞ÑÍ≤∞ÌïòÍ≤å

        ## Ï£ºÏöî Î≥ÄÍ≤Ω ÏÇ¨Ìï≠
        Í∏∞Îä•/Î™®Îìà Îã®ÏúÑÎ°ú **Ï§ëÏöîÌïú Î≥ÄÍ≤ΩÏÇ¨Ìï≠Îßå** ÏûëÏÑ± (ÌååÏùº ÎÇòÏó¥ Í∏àÏßÄ)
        ÌïÑÏöîÏãú ### ÎòêÎäî #### ÏÑúÎ∏åÏÑπÏÖòÏúºÎ°ú Íµ¨Î∂Ñ

        ## ÏÉÅÏÑ∏ Íµ¨ÌòÑ ÎÇ¥Ïö©
        Ïù¥Ìï¥Ïóê ÌïÑÏöîÌïú **ÌïµÏã¨ ÎÇ¥Ïö©Îßå** ÏûëÏÑ±:
        - ÏïÑÌÇ§ÌÖçÏ≤òÎÇò Íµ¨Ï°∞ Î≥ÄÍ≤ΩÏù¥ ÏûàÎã§Î©¥ ÏÑ§Î™Ö
        - Ï§ëÏöîÌïú Î°úÏßÅÏù¥ÎÇò ÏïåÍ≥†Î¶¨Ï¶òÏù¥ ÏûàÎã§Î©¥ ÏÑ§Î™Ö
        - ÌäπÎ≥ÑÌïú Í∏∞Ïà†Ï†Å Í≤∞Ï†ïÏù¥ ÏûàÎã§Î©¥ Í∑∏ Ïù¥Ïú†ÏôÄ Ìï®Íªò ÏÑ§Î™Ö
        - Ï§ëÏöîÌïòÏßÄ ÏïäÏùÄ ÎÇ¥Ïö©ÏùÄ ÏÉùÎûµ
        - ÌïÑÏöîÏãú ### ÎòêÎäî #### ÏÑúÎ∏åÏÑπÏÖòÏúºÎ°ú Íµ¨Î∂Ñ

        ## Ìä∏Îü¨Î∏î ÏäàÌåÖ
        - Íµ¨ÌòÑ Ï§ë Î∞úÏÉùÌïú Î¨∏Ï†úÏôÄ Ìï¥Í≤∞ Î∞©Î≤ïÏù¥ ÏûàÎã§Î©¥ ÏûëÏÑ±
        - ÏóÜÏúºÎ©¥: "- Ìä∏Îü¨Î∏îÏäàÌåÖ ÏÇ¨Ìï≠ ÏóÜÏùå"

        **Ï†àÎåÄ Ï∂îÍ∞Ä Í∏àÏßÄ:**
        Ï£ºÏùòÏÇ¨Ìï≠, Í∂åÍ≥†ÏÇ¨Ìï≠, ÏïåÎ†§ÏßÑ Ïù¥Ïäà, Î¶¨Î∑∞ Ìè¨Ïù∏Ìä∏, ÌÖåÏä§Ìä∏ Í≥ÑÌöç Îì±Ïùò Ï∂îÍ∞Ä ÏÑπÏÖò

        Î∂ÑÏÑù Ïö∞ÏÑ†ÏàúÏúÑ:
        1) Stats 2) Files(Ïã†Í∑ú ÌååÏùº Ïö∞ÏÑ†) 3) Diff

        --- Stats ---
        EOF
        cat "${{ inputs.stats_file }}" >> /tmp/prompt.txt
        cat >> /tmp/prompt.txt << 'EOF'

        --- Files ---
        EOF
        cat "${{ inputs.files_file }}" >> /tmp/prompt.txt
        cat >> /tmp/prompt.txt << 'EOF'

        --- Diff ---
        EOF
        cat "${{ inputs.diff_file }}" >> /tmp/prompt.txt

        PROMPT="$(cat /tmp/prompt.txt)"
        echo "üìù Prompt size: $(printf "%s" "$PROMPT" | wc -c | tr -d ' ') characters"

        # -----------------------------
        # 2) Call OpenAI with retries
        # -----------------------------
        BODY=""

        for i in {1..3}; do
          echo "üîÑ OpenAI API Ìò∏Ï∂ú ÏãúÎèÑ $i/3"

          RESPONSE="$(curl -sS https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-5-mini\",
              \"input\": [
                {\"role\": \"system\", \"content\": \"Write a GitHub Pull Request body in Korean Markdown. Return markdown only.\"},
                {\"role\": \"user\", \"content\": $(printf \"%s\" \"$PROMPT\" | jq -Rs .)}
              ],
              \"max_output_tokens\": 4096
            }")"

          # API error Ï≤¥ÌÅ¨
          if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
            echo "‚ùå API Error: $(echo "$RESPONSE" | jq -r '.error.message // .error')"
            [ $i -lt 3 ] && sleep $((i * 2))
            continue
          fi

          # Markdown Î≥∏Î¨∏ Ï∂îÏ∂ú
          BODY="$(echo "$RESPONSE" | jq -r '[.output[]?.content[]?.text // ""] | join("")')"

          if [ -n "$BODY" ] && [ "$BODY" != "null" ]; then
            echo "‚úÖ PR ÏÉùÏÑ± ÏôÑÎ£å"
            break
          fi

          echo "‚ö†Ô∏è  Î≥∏Î¨∏ Ï∂îÏ∂ú Ïã§Ìå® - Ïû¨ÏãúÎèÑ Ï§ë"
          [ $i -lt 3 ] && sleep $((i * 2))
        done

        if [ -z "$BODY" ] || [ "$BODY" = "null" ]; then
          echo "‚ùå OpenAI API Ìò∏Ï∂ú Ïã§Ìå®(Î≥∏Î¨∏ ÎπÑÏñ¥ÏûàÏùå)"
          exit 1
        fi

        # -----------------------------
        # 3) Use markdown AS-IS
        # -----------------------------
        echo "body<<EOF" >> "$GITHUB_OUTPUT"
        printf "%s\n" "$BODY" >> "$GITHUB_OUTPUT"
        echo "EOF" >> "$GITHUB_OUTPUT"
